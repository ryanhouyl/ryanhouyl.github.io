<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content=""><title>Java AQSè§£æ(2) | 0x80x17</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=1.0.0"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/normalize/latest/normalize.min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/latest/pure-min.min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/latest/grids-responsive-min.min.css"><link rel="stylesheet" href="//lib.baomitu.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//lib.baomitu.com/jquery/latest/jquery.min.js"></script><link rel="icon" mask="" sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><script type="text/javascript" src="//lib.baomitu.com/clipboard.js/latest/clipboard.min.js"></script><script type="text/javascript" src="//lib.baomitu.com/toastr.js/latest/toastr.min.js"></script><link rel="stylesheet" href="//lib.baomitu.com/toastr.js/latest/toastr.min.css"><meta name="generator" content="Hexo 7.0.0"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">Java AQSè§£æ(2)</h1><a id="logo" href="/.">0x80x17</a><p class="description">hello, world:)</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> é¦–é¡µ</i></a><a href="/archives/"><i class="fa fa-archive"> å½’æ¡£</i></a><a href="/about/"><i class="fa fa-user"> å…³äº</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">Java AQSè§£æ(2)</h1><div class="post-meta">2023-01-15</div><div class="clear"><div class="toc-article" id="toc"><div class="toc-title">æ–‡ç« ç›®å½•</div><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#Blocking"><span class="toc-text">Blocking</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Queues"><span class="toc-text">Queues</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#show-me-the-code"><span class="toc-text">show me the code</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8E%A8%E8%8D%90%E9%98%85%E8%AF%BB%EF%BC%9A"><span class="toc-text">æ¨èé˜…è¯»ï¼š</span></a></li></ol></div></div><div class="post-content"><p>æ¥ç€ä¸Šä¸€ç¯‡å…³äºAQSçš„æ–‡ç«  <a href="https://0x80x17.tech/2023/01/09/Java-AQS%E8%A7%A3%E6%9E%90-1/">Java AQSè§£æ(1)</a> ç»§ç»­åˆ†æï¼Œæ¥ä¸‹æ¥æ˜¯AQSæ¡†æ¶çš„ç¬¬äºŒä¸ªé‡è¦ç»„æˆéƒ¨åˆ†ã€‚</p>
<h3 id="Blocking"><a href="#Blocking" class="headerlink" title="Blocking"></a>Blocking</h3><p>åœ¨ JSR166 ä¹‹å‰ï¼Œé™¤äº†åŸºäºå†…ç½®çš„ monitor çš„æ–¹æ³•å¤–(wait&#x2F;notify)ï¼ŒJava æ²¡æœ‰å¯ç”¨çš„APIç”¨äºçº¿ç¨‹é˜»å¡å’Œå”¤é†’æ“ä½œæ¥å®ç°åŒæ­¥å™¨ã€‚å”¯ä¸€å¯ç”¨çš„å¤‡é€‰æ–¹æ¡ˆæ˜¯ <code>Thread.suspend</code> å’Œ <code>Thread.resume</code>ï¼Œä½†æ˜¯è¿™ä¸¤ä¸ªæ–¹æ³•åœ¨é‡åˆ°ç«æ€é—®é¢˜æ—¶ä¼šå‡ºç°æ— æ³•è§£å†³çš„é—®é¢˜ï¼Œæ¯”å¦‚ï¼šå½“ä¸€ä¸ªå½“å‰æœªè¢«é˜»å¡çš„çº¿ç¨‹åœ¨ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œ <code>suspend</code> æ–¹æ³•ä¹‹å‰è°ƒç”¨ <code>resume</code>  æ–¹æ³•ï¼Œé‚£ä¹ˆè¿™ä¸ª <code>resume</code> æ–¹æ³•å°†æ²¡æœ‰ä»»ä½•æ•ˆæœ(åé¢æåˆ°çš„ LockSupport é€šè¿‡ç»™æ¯ä¸ªçº¿ç¨‹å¼•å…¥ä¸€ä¸ªpermitè§£å†³äº†è¿™ä¸ªé—®é¢˜)</p>
<span id="more"></span>

<p>j.u.c åŒ…ä¸­æ–°å¢äº†ä¸€ä¸ª  <code>LockSupport</code> ç±»æä¾›äº†çº¿ç¨‹çš„ blocking&#x2F;unblocking æ“ä½œ(LockSupport: <strong>Basic thread blocking primitives for creating locks and other synchronization classes.</strong>)ï¼Œæ¨èå»çœ‹è¯¥ç±»çš„jdkæ–‡æ¡£ï¼Œä»‹ç»çš„å¾ˆæ¸…æ¥šã€‚</p>
<p>è¯¥ç±»æä¾›äº†ä¸¤ä¸ªæœ€æ ¸å¿ƒçš„æ–¹æ³•ï¼š</p>
<ul>
<li>park: å¦‚æœå½“å‰çº¿ç¨‹çš„permitæ˜¯å¯ç”¨çš„(available)ï¼Œé‚£ä¹ˆç”¨æ‰è¯¥permitï¼Œå¹¶ç›´æ¥è¿”å› ( A thread invoking park on a new synchronizer might return immediately because of a â€œleftoverâ€ unpark from a previous usage. However, in the absence of an unpark, its next invocation will block. )ã€‚å¦åˆ™å½“å‰çº¿ç¨‹ä¼‘çœ ï¼Œç›´åˆ°ä¸‹é¢ä¸‰ä»¶äº‹ä¹‹ä¸€å‘ç”Ÿï¼š1ï¼‰å…¶å®ƒçº¿ç¨‹å¯¹è¯¥çº¿ç¨‹è°ƒç”¨äº†<code>unpark</code>æ–¹æ³•;  2)å…¶å®ƒçº¿ç¨‹è°ƒç”¨äº†è¯¥çº¿ç¨‹çš„ <code>interrupt</code>æ–¹æ³•; 3)è¯¥è°ƒç”¨å› ä¸ºåˆ«çš„æœªçŸ¥åŸå› è¿”å›(spuriously return)ã€‚è¯¥æ–¹æ³•è°ƒç”¨ä¸èƒ½è¡¨æ˜æ˜¯å› ä¸ºå“ªç§åŸå› è¿”å›çš„ï¼Œæ‰€ä»¥è°ƒç”¨è€…éœ€è¦è‡ªå·±é‡æ–°æ£€æŸ¥ park è¿”å›çš„åŸå› (é€šå¸¸æ˜¯é€šè¿‡ä¸€ä¸ª while å¾ªç¯)ï¼Œæ¯”å¦‚å¯ä»¥æ£€æŸ¥çº¿ç¨‹çš„ <code>interrupt status</code></li>
<li>unpark: å¦‚æœè¢«unparkçš„çº¿ç¨‹æœ¬èº«çš„permitä¸æ˜¯availableçš„ï¼Œé‚£ä¹ˆæŠŠè¯¥çº¿ç¨‹çš„permitç½®ä¸ºavailableã€‚å¦‚æœè¯¥çº¿ç¨‹å¤„äºé˜»å¡çŠ¶æ€ï¼Œåˆ™å”¤é†’è¯¥çº¿ç¨‹ã€‚ä¸åŒäº Semaphoreï¼Œpermit å€¼ä¸ä¼šç´¯åŠ ï¼Œå› æ­¤åœ¨è°ƒç”¨parkæ–¹æ³•ä¹‹å‰è°ƒç”¨å¤šæ¬¡unparkæ–¹æ³•ä¹Ÿåªèƒ½<code>unblock a single park</code></li>
</ul>
<h3 id="Queues"><a href="#Queues" class="headerlink" title="Queues"></a>Queues</h3><p>AQS æ¡†æ¶æœ€æ ¸å¿ƒçš„éƒ¨åˆ†åœ¨äºç»´æŠ¤ä¸€ä¸ªé˜»å¡çº¿ç¨‹çš„é˜Ÿåˆ—ï¼Œåœ¨AQSä¸­è¯¥é˜Ÿåˆ—é™åˆ¶ä¸ºFIFOé˜Ÿåˆ—ï¼Œé€šè¿‡å¸¦å¤´èŠ‚ç‚¹çš„åŸºäºçŠ¶æ€çš„åŒé“¾è¡¨å®ç°</p>
<p>å¯¹äºæ„å»ºåŒæ­¥é˜Ÿåˆ—ï¼Œå¤§å®¶æ¯”è¾ƒä¸€è‡´çš„æ˜¯éœ€è¦æ„å»ºéé˜»å¡çš„æ•°æ®ç»“æ„(èƒ½æä¾›æ›´å¥½çš„ä¼¸ç¼©æ€§å’Œæ€§èƒ½ï¼Œä½†åŒæ—¶ä¹Ÿå¸¦æ¥äº†å®ç°ä¸Šçš„å¤æ‚åº¦)ï¼Œä¸»è¦æœ‰ä¸¤ç§æ–¹æ¡ˆï¼šMCSé”å’ŒCLHé”ï¼ŒCLHé”ä¹‹å‰ä¸»è¦ç”¨æ¥å®ç°è‡ªæ—‹é”ï¼Œé€šè¿‡æ”¹è¿›åï¼ŒCLHé”å¯ä»¥æ›´å¥½çš„æ”¯æŒçº¿ç¨‹å–æ¶ˆå’Œè¶…æ—¶æ“ä½œï¼Œå› è€ŒAQSé€‰æ‹©äº†åŸºäºCLHé”è¿›è¡Œæ”¹è¿›</p>
<p>AQSå¯¹äºCLHé”çš„æ”¹è¿›ä¸»è¦æœ‰ä¸¤ä¸ªæ–¹é¢ï¼š</p>
<ul>
<li>AQSä¸­æ¯ä¸ªèŠ‚ç‚¹éœ€è¦æœ‰ä¸ªæŒ‡é’ˆæŒ‡å‘åç»§èŠ‚ç‚¹(å•é“¾è¡¨å˜ä¸ºåŒé“¾è¡¨)ï¼Œåœ¨è‡ªæ—‹é”ä¸­ï¼Œæ¯ä¸ªèŠ‚ç‚¹åªéœ€è¦æ”¹å˜è‡ªå·±çš„çŠ¶æ€ï¼Œåç»­çš„èŠ‚ç‚¹åœ¨ä¸‹ä¸€æ¬¡è‡ªæ—‹æ—¶å°±ä¼šæ„ŸçŸ¥åˆ°ï¼Œæ‰€ä»¥ä¸éœ€è¦é“¾æ¥åç»§èŠ‚ç‚¹ã€‚ä½†æ˜¯åœ¨é˜»å¡åŒæ­¥å™¨ä¸­ï¼Œä¸€ä¸ªèŠ‚ç‚¹éœ€è¦å”¤é†’(wake up&#x2F;unpark)å¥¹çš„åç»§èŠ‚ç‚¹ã€‚è¿™é‡Œæœ‰ä¸€ä¸ªåœ°æ–¹éœ€è¦æ³¨æ„ï¼Œå› ä¸ºæˆ‘ä»¬ç›®å‰æ²¡æœ‰ç›¸å…³æŠ€æœ¯å®ç°åŸå­çš„æ— é”çš„æ’å…¥åŒé“¾è¡¨èŠ‚ç‚¹ï¼Œæ‰€ä»¥åç»§èŠ‚ç‚¹çš„æ“ä½œä¸æ˜¯åŸå­çš„ï¼Œåªæ˜¯ç®€å•çš„<code>pred.next = node;</code>ï¼Œnext é“¾æ¥åªæ˜¯ä½œä¸ºä¼˜åŒ–è·¯å¾„ï¼Œå½“æˆ‘ä»¬é€šè¿‡ä¸€ä¸ªèŠ‚ç‚¹çš„nextæ‹¿ä¸åˆ°åç»§èŠ‚ç‚¹æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨åŒé“¾è¡¨çš„é“¾å°¾é€šè¿‡prevæŒ‡é’ˆå‘å‰å¾ªç¯æ¥ç¡®å®šæ˜¯ä¸æ˜¯è¯¥èŠ‚ç‚¹çš„ç¡®ä¸å­˜åœ¨åç»§èŠ‚ç‚¹</li>
<li>ç¬¬äºŒä¸ªä¸»è¦çš„æ”¹è¿›åœ¨äºï¼Œåœ¨AQSé˜Ÿåˆ—çš„nodeä¸­ä¿å­˜çš„çŠ¶æ€statusæ˜¯ä¸ºäº†æ§åˆ¶blockingè€Œä¸æ˜¯spinningã€‚åœ¨é˜Ÿåˆ—ä¸­ï¼Œåªæœ‰å¤„äºé˜Ÿé¦–çš„activeçŠ¶æ€çš„çº¿ç¨‹æ‰å…è®¸è°ƒç”¨ tryAcquire æ–¹æ³•ï¼Œä½†æ˜¯è¿™ä¸éœ€è¦é¢å¤–çš„çŠ¶æ€æ¥åˆ¤æ–­ï¼Œåªéœ€è¦åˆ¤æ–­å½“å‰èŠ‚ç‚¹çš„å‰é©±èŠ‚ç‚¹æ˜¯ä¸æ˜¯headå³å¯ã€‚å–æ¶ˆçŠ¶æ€åˆ™å¿…é¡»ä¾èµ–è¯¥statusã€‚åŒæ—¶èŠ‚ç‚¹çš„statusçŠ¶æ€å¯ä»¥ç”¨æ¥é¿å…ä¸å¿…è¦çš„parkå’Œunparkæ“ä½œï¼Œåœ¨è°ƒç”¨parkæ“ä½œå‰ï¼Œçº¿ç¨‹ä¼šè®¾ç½®(prodecessor)â€œsignal meâ€bitï¼Œç„¶ååœ¨çœŸæ­£è°ƒç”¨parkæ“ä½œå‰ï¼Œé‡æ–°æ£€æŸ¥åŒæ­¥çŠ¶æ€å’ŒèŠ‚ç‚¹statusçŠ¶æ€ï¼›åœ¨çº¿ç¨‹é‡Šæ”¾é”æ—¶ï¼Œå¯ä»¥æ ¹æ®successoræ˜¯å¦è®¾ç½®äº† signal bit æ¥ç¡®å®šå¯¹å“ªä¸ªNodeèŠ‚ç‚¹è¿›è¡Œunparkæ“ä½œï¼›æ¨èå»é˜…è¯» AQS æºç ä¸­Nodeçš„å®šä¹‰å’Œæ–‡æ¡£ï¼Œéƒ¨åˆ†é‡è¦çš„æ•°æ®ç»“æ„å¦‚ä¸‹ï¼š</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">Node</span> &#123;</span><br><span class="line">	<span class="comment">/** Marker to indicate a node is waiting in shared mode */</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Node</span> <span class="variable">SHARED</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Node</span>();</span><br><span class="line">    <span class="comment">/** Marker to indicate a node is waiting in exclusive mode */</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Node</span> <span class="variable">EXCLUSIVE</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">/** waitStatus value to indicate thread has cancelled */</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">CANCELLED</span> <span class="operator">=</span>  <span class="number">1</span>;</span><br><span class="line">    <span class="comment">/** waitStatus value to indicate successor&#x27;s thread needs unparking */</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">SIGNAL</span>    <span class="operator">=</span> -<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">volatile</span> <span class="type">int</span> waitStatus;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">volatile</span> Node prev;</span><br><span class="line">    <span class="keyword">volatile</span> Node next;</span><br><span class="line">    <span class="keyword">volatile</span> Thread thread;</span><br><span class="line">    Node nextWaiter;</span><br><span class="line">    ...</span><br><span class="line">&#125;    </span><br></pre></td></tr></table></figure>

<h3 id="show-me-the-code"><a href="#show-me-the-code" class="headerlink" title="show me the code"></a>show me the code</h3><p>ä¸Šé¢åˆ†æäº†å…³äºAQSæœ€æ ¸å¿ƒçš„ä¸‰ä¸ªç»„æˆéƒ¨åˆ†ï¼Œå†…å®¹å¤§éƒ¨åˆ†æ¥è‡ª Doug Lea çš„è®ºæ–‡å’Œéƒ¨åˆ†æ–‡æ¡£ï¼Œæ¯”è¾ƒæŠ½è±¡ï¼Œæ¥ä¸‹æ¥é€šè¿‡ä¾æ®AQSæ¡†æ¶å®ç°çš„å…·ä½“åŒæ­¥å™¨ï¼ï¼<strong>å¯é‡å…¥äº’æ–¥é”ReentrantLock</strong>çš„ä»£ç æ¥å…·ä½“è¯´æ˜ä¸‹</p>
<p>åœ¨å¼€å§‹èµ°è¯»ä»£ç å‰ï¼Œå…ˆäº¤ä»£ä¸¤ä»¶äº‹ï¼ŒAQSæ¡†æ¶å­˜åœ¨<code>exclusive</code>å’Œ<code>shared</code> æ¨¡å¼ï¼Œæ•…åæ€ä¹‰ï¼Œä¸€ç§æ¨¡å¼æ˜¯äº’æ–¥æ¨¡å¼ï¼Œä¸€æ¬¡åªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹å¯ä»¥æ‰§è¡Œæ“ä½œï¼›ä¸€ç§æ˜¯å…±äº«æ¨¡å¼ï¼Œå¯ä»¥å­˜åœ¨å¤šä¸ªçº¿ç¨‹è¿›è¡Œæ“ä½œï¼Œæ¯”å¦‚è¯»å†™é”ä¸­çš„è¯»é”ï¼›åœ¨AQSçš„é˜Ÿåˆ—å®ç°ä¸­å­˜åœ¨å…¬å¹³å’Œéå…¬å¹³ä¸¤ç§ç­–ç•¥ï¼Œéå…¬å¹³ç­–ç•¥å¯ä»¥æ”¯æŒæ›´å¤§çš„ååä½†æ˜¯å¯¹äºèµ„æºçš„ä½¿ç”¨å­˜åœ¨ä¸å…¬å¹³ï¼Œå¯èƒ½å¯¼è‡´çº¿ç¨‹é¥¥é¥¿ï¼Œä¸‹é¢ä»£ç ä»¥äº’æ–¥æ¨¡å¼å’Œéå…¬å¹³ç­–ç•¥ä¸ºä¾‹ï¼Œå…¶ä»–å®ç°å¯ä»¥å‚è§ç›¸å…³ä»£ç </p>
<p>å…ˆçœ‹ReentrantLock çš„æ„é€ æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">ReentrantLock</span><span class="params">()</span> &#123;</span><br><span class="line">    sync = <span class="keyword">new</span> <span class="title class_">NonfairSync</span>();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="title function_">ReentrantLock</span><span class="params">(<span class="type">boolean</span> fair)</span> &#123;</span><br><span class="line">    sync = fair ? <span class="keyword">new</span> <span class="title class_">FairSync</span>() : <span class="keyword">new</span> <span class="title class_">NonfairSync</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¾ˆå®¹æ˜“çœ‹åˆ°ï¼Œç±»ä¸­å­˜åœ¨ä¸€ä¸ªsyncå±æ€§ï¼Œå­˜åœ¨ä¸¤ç§ä¸åŒçš„å®ç°ç±»ï¼Œé»˜è®¤æ˜¯ NonfairSync ç±»ï¼Œä¹Ÿå°±æ˜¯é‡‡ç”¨éå…¬å¹³ç­–ç•¥å®ç°çš„æ’ä»–é”ã€‚æ¥ä¸‹æ¥é‡ç‚¹å…³æ³¨lock()æ–¹æ³•çš„å®ç°ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">lock</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (compareAndSetState(<span class="number">0</span>, <span class="number">1</span>))</span><br><span class="line">        setExclusiveOwnerThread(Thread.currentThread());</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        acquire(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Acquires in exclusive mode, ignoring interrupts.  Implemented</span></span><br><span class="line"><span class="comment"> * by invoking at least once &#123;<span class="doctag">@link</span> #tryAcquire&#125;,</span></span><br><span class="line"><span class="comment"> * returning on success.  Otherwise the thread is queued, possibly</span></span><br><span class="line"><span class="comment"> * repeatedly blocking and unblocking, invoking &#123;<span class="doctag">@link</span></span></span><br><span class="line"><span class="comment"> * #tryAcquire&#125; until success.  This method can be used</span></span><br><span class="line"><span class="comment"> * to implement method &#123;<span class="doctag">@link</span> Lock#lock&#125;.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> arg the acquire argument.  This value is conveyed to</span></span><br><span class="line"><span class="comment"> *        &#123;<span class="doctag">@link</span> #tryAcquire&#125; but is otherwise uninterpreted and</span></span><br><span class="line"><span class="comment"> *        can represent anything you like.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">acquire</span><span class="params">(<span class="type">int</span> arg)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!tryAcquire(arg) &amp;&amp;</span><br><span class="line">      acquireQueued(addWaiter(Node.EXCLUSIVE), arg))</span><br><span class="line">        selfInterrupt();</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>åœ¨lockæ–¹æ³•ä¸­ï¼Œå…ˆè¿›è¡ŒCASæ“ä½œï¼Œå¦‚æœå½“å‰åŒæ­¥çŠ¶æ€ä¸º0ï¼Œä¹Ÿå°±æ˜¯è¿˜æ²¡æœ‰çº¿ç¨‹è·å–åˆ°é”ï¼Œå°è¯•ç”¨CASæŠŠåŒæ­¥çŠ¶æ€å˜ä¸º1ï¼Œå¦‚æœæˆåŠŸåˆ™è¡¨ç¤ºå½“å‰çº¿ç¨‹è·å–äº†é”ï¼Œå¹¶æŠŠå½“å‰çº¿ç¨‹è®¾ç½®ä¸ºOwnerï¼Œå¦‚æœå¤±è´¥åˆ™è°ƒç”¨ acquire(1)ï¼Œæ¥ä¸‹æ¥çš„ acquireæ–¹æ³•æ˜¯æ ¸å¿ƒæ–¹æ³•ï¼Œè¯¥æ–¹æ³•çš„æ–¹æ³•ç­¾åå¾ˆæ¸…æ¥šçš„è¯´æ˜äº†è¯¥æ–¹æ³•çš„ä½œç”¨</p>
<p>åœ¨ acquire æ–¹æ³•ä¸­ï¼Œå…ˆè°ƒç”¨ tryAcquire æ–¹æ³•ï¼Œè¯¥æ–¹æ³•åœ¨ NonfairSync ç±»ä¸­çš„å®ç°ä»£ç ä¸ºï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">nonfairTryAcquire</span><span class="params">(<span class="type">int</span> acquires)</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">Thread</span> <span class="variable">current</span> <span class="operator">=</span> Thread.currentThread();</span><br><span class="line">    <span class="type">int</span> <span class="variable">c</span> <span class="operator">=</span> getState();</span><br><span class="line">    <span class="keyword">if</span> (c == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (compareAndSetState(<span class="number">0</span>, acquires)) &#123;</span><br><span class="line">            setExclusiveOwnerThread(current);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (current == getExclusiveOwnerThread()) &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">nextc</span> <span class="operator">=</span> c + acquires;</span><br><span class="line">        <span class="keyword">if</span> (nextc &lt; <span class="number">0</span>) <span class="comment">// overflow</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&quot;Maximum lock count exceeded&quot;</span>);</span><br><span class="line">        setState(nextc);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä»£ç ç»“æ„å¾ˆæ¸…æ™°ï¼Œå…ˆè·å–åŒæ­¥çŠ¶æ€cï¼Œå¦‚æœå€¼ä¸º0ï¼Œä¹Ÿå°±æ˜¯å½“å‰è¿˜æ²¡æœ‰çº¿ç¨‹è·å–åˆ°é”(ä¹Ÿå¯èƒ½æ˜¯ä¹‹å‰æœ‰çº¿ç¨‹é‡Šæ”¾äº†é”ï¼‰ï¼Œå°è¯•é€šè¿‡CASæ“ä½œè·å–é”ï¼Œå¦‚æœæˆåŠŸåˆ™è®¾ç½®å½“å‰çº¿ç¨‹ä¸ºOwnerï¼Œè¿”å›trueï¼›å¦‚æœåŒæ­¥çŠ¶æ€ä¸ä¸º0ï¼Œåˆ¤æ–­å½“å‰çº¿ç¨‹æ˜¯ä¸æ˜¯Ownerï¼Œå¦‚æœæ˜¯åˆ™æŠŠåŒæ­¥çŠ¶æ€å¢åŠ acquiresï¼Œè¿”å›trueï¼›å…¶å®ƒè¿”å›falseã€‚åœ¨å¤–å±‚çš„ acquire æ–¹æ³•ä¸­ï¼Œå¦‚æœ tryAcquire æ–¹æ³•è¿”å›æˆåŠŸï¼Œåˆ™ä¸ä¼šèµ° <code>&amp;&amp;</code> ä¹‹åçš„æ–¹æ³•ï¼›å¦‚æœ tryAcquire æ–¹æ³•è¿”å›falseï¼Œç»§ç»­è°ƒç”¨åç»­æ–¹æ³•<code>acquireQueued(addWaiter(Node.EXCLUSIVE), arg))</code>ï¼Œå…ˆçœ‹ä¸‹æ–¹æ³•ï¼š<code>addWaiter(Node mode)</code>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Creates and enqueues node for current thread and given mode.</span></span><br><span class="line"><span class="keyword">private</span> Node <span class="title function_">addWaiter</span><span class="params">(Node mode)</span> &#123;</span><br><span class="line">    <span class="type">Node</span> <span class="variable">node</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Node</span>(Thread.currentThread(), mode);</span><br><span class="line">    <span class="comment">// Try the fast path of enq; backup to full enq on failure</span></span><br><span class="line">    <span class="type">Node</span> <span class="variable">pred</span> <span class="operator">=</span> tail;</span><br><span class="line">    <span class="keyword">if</span> (pred != <span class="literal">null</span>) &#123;</span><br><span class="line">        node.prev = pred;</span><br><span class="line">        <span class="keyword">if</span> (compareAndSetTail(pred, node)) &#123;</span><br><span class="line">            pred.next = node;</span><br><span class="line">            <span class="keyword">return</span> node;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    enq(node);</span><br><span class="line">    <span class="keyword">return</span> node;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> Node <span class="title function_">enq</span><span class="params">(<span class="keyword">final</span> Node node)</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        <span class="type">Node</span> <span class="variable">t</span> <span class="operator">=</span> tail;</span><br><span class="line">        <span class="keyword">if</span> (t == <span class="literal">null</span>) &#123; <span class="comment">// Must initialize</span></span><br><span class="line">            <span class="keyword">if</span> (compareAndSetHead(<span class="keyword">new</span> <span class="title class_">Node</span>()))</span><br><span class="line">                tail = head;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            node.prev = t;</span><br><span class="line">            <span class="keyword">if</span> (compareAndSetTail(t, node)) &#123;</span><br><span class="line">                t.next = node;</span><br><span class="line">                <span class="keyword">return</span> t;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å…ˆæŠŠå½“å‰çº¿ç¨‹æ„å»ºåœ¨äº’æ–¥æ¨¡å¼çš„NodeèŠ‚ç‚¹ä¸­ï¼Œç„¶åæ“ä½œå…¥é˜Ÿæ“ä½œï¼ŒæŠŠè¯¥èŠ‚ç‚¹æ”¾åˆ°é˜Ÿå°¾ã€‚åœ¨å…¥é˜Ÿæ—¶ï¼Œå…ˆæŠŠå°¾èŠ‚ç‚¹tailèµ‹ç»™ predï¼Œå¦‚æœå°¾èŠ‚ç‚¹ä¸ä¸ºç©ºï¼Œå…ˆå°è¯•èµ° fast pathï¼Œä¹Ÿå°±æ˜¯æŠŠå½“å‰èŠ‚ç‚¹çš„å‰é©±èŠ‚ç‚¹æŒ‡å‘predï¼Œç„¶åé€šè¿‡CASæ“ä½œå°è¯•(åœ¨éé˜»å¡çš„æ•°æ®ç»“æ„ä¸­å„ç§CASå°è¯•ï¼Œæ¯•ç«Ÿæ¯”èµ·å†…ç½®é”è¿™ç§é‡é‡çº§æ“ä½œï¼ŒCASè¿˜æ˜¯å¾ˆåˆ’ç®—çš„)æŠŠå°¾èŠ‚ç‚¹è®¾ç½®ä¸ºnodeï¼Œå¦‚æœæˆåŠŸï¼ŒæŠŠ pred çš„åç»§èŠ‚ç‚¹æŒ‡å‘nodeèŠ‚ç‚¹ï¼Œè¿”å›è¯¥èŠ‚ç‚¹å³å¯(ç›¸å½“äºé€šè¿‡CASçº¿ç¨‹å®‰å…¨çš„æŠŠè¯¥èŠ‚ç‚¹æ’å…¥äº†é˜Ÿå°¾)ã€‚å¦‚æœä¸Šè¿°æ“ä½œå¤±è´¥ï¼Œæ¯”å¦‚åˆå§‹æƒ…å†µä¸‹ï¼Œheadå’Œtailå‡ä¸ºnullï¼Œç›´æ¥èµ°å…¥é˜Ÿæ“ä½œæ–¹æ³•<code>enq</code></p>
<p><code>enq</code>æ–¹æ³•çš„ä»£ç å¦‚ä¸Šï¼Œä¹Ÿå¾ˆæ¸…æ™°ï¼Œé€šè¿‡å¾ªç¯å’ŒCASä¿è¯çº¿ç¨‹å®‰å…¨çš„åœ¨é˜Ÿå°¾æ–°å¢åŠ å…¥é˜ŸèŠ‚ç‚¹ã€‚æœ€å¤–å±‚æ­»å¾ªç¯ä¿è¯äº†åœ¨å¤šçº¿ç¨‹è¿›è¡Œæ“ä½œæ—¶ï¼Œå¦‚æœCASæ“ä½œå¤±è´¥ï¼Œçº¿ç¨‹ä¼šä¸æ–­è‡ªæ—‹ç›´åˆ°æ“ä½œå…¥é˜ŸæˆåŠŸï¼Œelse åˆ†æ”¯çš„æ“ä½œåˆ™é€šè¿‡CASä¿è¯äº†å¤šçº¿ç¨‹å¯ä»¥çº¿ç¨‹å®‰å…¨çš„å…¥é˜Ÿä¸€ä¸ªèŠ‚ç‚¹(åŒé“¾è¡¨å°¾æ’æ³•æ–°å¢èŠ‚ç‚¹)</p>
<p>èŠ‚ç‚¹å…¥é˜ŸæˆåŠŸåï¼Œè°ƒç”¨<code>acquireQueued(final Node node, int arg)</code>æ–¹æ³•ï¼Œåˆ¤æ–­è¯¥èŠ‚ç‚¹çº¿ç¨‹æ˜¯å¦åœ¨å¤´éƒ¨ï¼Œèƒ½å¦å°è¯•å†æ¬¡è·å–é”ï¼Œæˆ–è€…åˆ¤æ–­æ˜¯å¦éœ€è¦æŒ‚èµ·è¯¥çº¿ç¨‹(è°ƒç”¨parkæ–¹æ³•)ï¼Œè¯¥èŠ‚ç‚¹çº¿ç¨‹å¯èƒ½ä¼šè¢«å¤šæ¬¡é˜»å¡å’Œå”¤é†’ï¼Œç›´åˆ°æˆåŠŸè·å–åˆ°é”å¹¶è¿”å›ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">acquireQueued</span><span class="params">(<span class="keyword">final</span> Node node, <span class="type">int</span> arg)</span> &#123;</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">failed</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">interrupted</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="type">Node</span> <span class="variable">p</span> <span class="operator">=</span> node.predecessor();</span><br><span class="line">            <span class="keyword">if</span> (p == head &amp;&amp; tryAcquire(arg)) &#123;</span><br><span class="line">                setHead(node);</span><br><span class="line">                p.next = <span class="literal">null</span>; <span class="comment">// help GC</span></span><br><span class="line">                failed = <span class="literal">false</span>;</span><br><span class="line">                <span class="keyword">return</span> interrupted;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (shouldParkAfterFailedAcquire(p, node) &amp;&amp;</span><br><span class="line">                parkAndCheckInterrupt())</span><br><span class="line">                interrupted = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (failed)</span><br><span class="line">            cancelAcquire(node);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Checks and updates status for a node that failed to acquire.</span></span><br><span class="line"><span class="comment"> * Returns true if thread should block. This is the main signal</span></span><br><span class="line"><span class="comment"> * control in all acquire loops.  Requires that pred == node.prev.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> pred node&#x27;s predecessor holding status</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> node the node</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> &#123;<span class="doctag">@code</span> true&#125; if thread should block</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">shouldParkAfterFailedAcquire</span><span class="params">(Node pred, Node node)</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">ws</span> <span class="operator">=</span> pred.waitStatus;</span><br><span class="line">    <span class="keyword">if</span> (ws == Node.SIGNAL)</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * This node has already set status asking a release</span></span><br><span class="line"><span class="comment">         * to signal it, so it can safely park.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">if</span> (ws &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * Predecessor was cancelled. Skip over predecessors and</span></span><br><span class="line"><span class="comment">         * indicate retry.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">do</span> &#123;</span><br><span class="line">            node.prev = pred = pred.prev;</span><br><span class="line">        &#125; <span class="keyword">while</span> (pred.waitStatus &gt; <span class="number">0</span>);</span><br><span class="line">        pred.next = node;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * waitStatus must be 0 or PROPAGATE.  Indicate that we</span></span><br><span class="line"><span class="comment">         * need a signal, but don&#x27;t park yet.  Caller will need to</span></span><br><span class="line"><span class="comment">         * retry to make sure it cannot acquire before parking.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        compareAndSetWaitStatus(pred, ws, Node.SIGNAL);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å…ˆçœ‹acquireQueuedæ–¹æ³•ï¼Œå¤–å±‚æ˜¯ä¸€ä¸ªæ­»å¾ªç¯ï¼Œå…ˆåˆ¤æ–­å½“å‰èŠ‚ç‚¹çš„å‰ä¸€ä¸ªèŠ‚ç‚¹æ˜¯ä¸æ˜¯å¤´èŠ‚ç‚¹ï¼Œå¦‚æœæ˜¯çš„è¯ï¼Œå°è¯•è·å–é”ï¼Œå¦‚æœæˆåŠŸï¼Œåˆ™æŠŠå½“å‰nodeèŠ‚ç‚¹è®¾ç½®ä¸ºå¤´èŠ‚ç‚¹ï¼ŒæŠŠåŸæ¥å¤´èŠ‚ç‚¹çš„åç»§æŒ‡é’ˆæ–­å¼€(<strong>å®ç°å…ˆè¿›å…ˆå‡ºæ“ä½œï¼Œé˜Ÿå°¾å…¥é˜Ÿï¼Œé˜Ÿé¦–å‡ºé˜Ÿ</strong>)ï¼Œå¦‚æœå¤±è´¥ï¼Œè°ƒç”¨<code>shouldParkAfterFailedAcquire</code>æ–¹æ³•ï¼Œæ ¹æ®å½“å‰èŠ‚ç‚¹çš„å‰é©±èŠ‚ç‚¹åˆ¤æ–­æ˜¯å¦éœ€è¦æŒ‚èµ·å½“å‰èŠ‚ç‚¹çš„çº¿ç¨‹ï¼Œå¹¶æ‰§è¡Œä¸€äº›å…¶å®ƒæ“ä½œï¼Œæ¯”å¦‚æ›´æ–°èŠ‚ç‚¹çŠ¶æ€ï¼Œå»é™¤cancelledçŠ¶æ€çš„èŠ‚ç‚¹ï¼Œè¯¥æ–¹æ³•çš„æºç å’Œæ³¨é‡Šå¾ˆæ¸…æ™°ä¸ç»†è¯´ã€‚å¦‚æœåˆ¤æ–­æˆåŠŸï¼Œåˆ™æ‰§è¡Œ<code>parkAndCheckInterrupt</code>æ–¹æ³•ï¼Œå¯¹å½“å‰çº¿ç¨‹è°ƒç”¨parkæ–¹æ³•ã€‚æœ€å¤–å±‚çš„forå¾ªç¯ä¿è¯äº†è¯¥èŠ‚ç‚¹çš„çº¿ç¨‹æœ€ç»ˆä¼šè·å–åˆ°é”</p>
<p>ä»¥ä¸Šï¼Œlockæ“ä½œåŸºæœ¬åˆ†æå®Œæ¯•ï¼Œç®€å•æ€»ç»“ä¸€ä¸‹ï¼Œ<strong>lockæ–¹æ³•å…ˆå°è¯•ä½¿ç”¨CASè·å–é”ï¼Œå¦‚æœæˆåŠŸï¼Œè®¾ç½®å½“å‰çº¿ç¨‹ä¸ºOwnerï¼Œå¦‚æœå¤±è´¥ï¼Œåˆ™è°ƒç”¨ acquire æ–¹æ³•ï¼Œåœ¨è¯¥æ–¹æ³•ä¸­ï¼Œå…ˆé€šè¿‡ tryAcquire æ–¹æ³•å†æ¬¡è·å–é”ï¼Œä¾ç„¶è¿˜æ˜¯é‡‡ç”¨CASæ“ä½œï¼Œè¯¥æ–¹æ³•å®ç°äº†çº¿ç¨‹é‡å…¥æ“ä½œï¼›å¦‚æœè·å–æˆåŠŸåˆ™è¿”å›ï¼Œå¦‚æœå¤±è´¥ï¼Œå…ˆæŠŠè¯¥èŠ‚ç‚¹çº¿ç¨‹å®‰å…¨çš„æ”¾ç½®åˆ°é˜Ÿå°¾(CAS+æ­»å¾ªç¯)ï¼Œå¹¶ä»è¯¥é˜Ÿåˆ—ä¸­è°ƒç”¨è¯¥èŠ‚ç‚¹è·å–é”(é€šè¿‡æ­»å¾ªç¯ï¼Œä¸æ–­åˆ¤æ–­å½“å‰èŠ‚ç‚¹æ˜¯å¦åœ¨é˜Ÿé¦–å¹¶å°è¯•è·å–é”ï¼Œå¤±è´¥åˆ™åˆ¤æ–­æ˜¯å¦éœ€è¦æŒ‚èµ·çº¿ç¨‹å¹¶æ‰§è¡Œç›¸åº”æ“ä½œï¼Œä¸€æ—¦æŒ‚èµ·åï¼Œéœ€è¦ç­‰å…¶å®ƒçº¿ç¨‹å¯¹è¯¥çº¿ç¨‹æ‰§è¡Œå”¤é†’æ“ä½œï¼Œè¢«å”¤é†’ç»§ç»­åˆ¤æ–­æ˜¯å¦å¤„äºé˜Ÿé¦–å¹¶å°è¯•è·å–é”ï¼Œç›´åˆ°æˆåŠŸè·å–å¹¶è¿”å›)</strong></p>
<p>å†åˆ†æä¸‹unlockæ“ä½œï¼Œç›¸å¯¹ç®€å•å¤šäº†:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">unlock</span><span class="params">()</span> &#123;</span><br><span class="line">    sync.release(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">release</span><span class="params">(<span class="type">int</span> arg)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (tryRelease(arg)) &#123;</span><br><span class="line">        <span class="type">Node</span> <span class="variable">h</span> <span class="operator">=</span> head;</span><br><span class="line">        <span class="keyword">if</span> (h != <span class="literal">null</span> &amp;&amp; h.waitStatus != <span class="number">0</span>)</span><br><span class="line">            unparkSuccessor(h);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">tryRelease</span><span class="params">(<span class="type">int</span> releases)</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">c</span> <span class="operator">=</span> getState() - releases;</span><br><span class="line">    <span class="keyword">if</span> (Thread.currentThread() != getExclusiveOwnerThread())</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalMonitorStateException</span>();</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">free</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">if</span> (c == <span class="number">0</span>) &#123;</span><br><span class="line">        free = <span class="literal">true</span>;</span><br><span class="line">        setExclusiveOwnerThread(<span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    setState(c);</span><br><span class="line">    <span class="keyword">return</span> free;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Wakes up node&#x27;s successor, if one exists.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> node the node</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">unparkSuccessor</span><span class="params">(Node node)</span> &#123;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * If status is negative (i.e., possibly needing signal) try</span></span><br><span class="line"><span class="comment">     * to clear in anticipation of signalling.  It is OK if this</span></span><br><span class="line"><span class="comment">     * fails or if status is changed by waiting thread.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">ws</span> <span class="operator">=</span> node.waitStatus;</span><br><span class="line">    <span class="keyword">if</span> (ws &lt; <span class="number">0</span>)</span><br><span class="line">        compareAndSetWaitStatus(node, ws, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * Thread to unpark is held in successor, which is normally</span></span><br><span class="line"><span class="comment">     * just the next node.  But if cancelled or apparently null,</span></span><br><span class="line"><span class="comment">     * traverse backwards from tail to find the actual</span></span><br><span class="line"><span class="comment">     * non-cancelled successor.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="type">Node</span> <span class="variable">s</span> <span class="operator">=</span> node.next;</span><br><span class="line">    <span class="keyword">if</span> (s == <span class="literal">null</span> || s.waitStatus &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        s = <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">Node</span> <span class="variable">t</span> <span class="operator">=</span> tail; t != <span class="literal">null</span> &amp;&amp; t != node; t = t.prev)</span><br><span class="line">            <span class="keyword">if</span> (t.waitStatus &lt;= <span class="number">0</span>)</span><br><span class="line">                s = t;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (s != <span class="literal">null</span>)</span><br><span class="line">        LockSupport.unpark(s.thread);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä»£ç å¾ˆæ¸…æ™°ï¼Œunlock æ“ä½œå…ˆå°è¯•é‡Šæ”¾é”ï¼Œåœ¨<code>tryRelease</code> æ–¹æ³•ä¸­ï¼Œå…ˆåˆ¤æ–­å½“å‰çº¿ç¨‹æ˜¯ä¸æ˜¯è¦é‡Šæ”¾çš„é”çš„ownerï¼Œå¦‚æœæ˜¯åˆ™å‡å»ä¼ å…¥çš„å‚æ•°ï¼Œåˆ¤æ–­ç»“æœæ˜¯ä¸æ˜¯0ï¼Œå¦‚æœæ˜¯çš„è¯ï¼Œè¯´æ˜æ²¡æœ‰çº¿ç¨‹å†å ç”¨è¯¥é”(ä¹Ÿå°±æ˜¯AQSä¸­çš„åŒæ­¥çŠ¶æ€)ï¼Œè¿”å›tureï¼Œå¦åˆ™è¿”å›falseï¼Œå¦‚æœè¿”å›tureï¼Œåˆ™è°ƒç”¨<code>unparkSuccessor</code>æ–¹æ³•ï¼Œå”¤é†’é˜Ÿé¦–çš„èŠ‚ç‚¹</p>
<p>åˆ°æ­¤ AQS æ¡†æ¶å’ŒåŸºäº AQS å®ç°çš„åŒæ­¥äº’æ–¥é” ReentrantLock çš„æ€»ç»“å°±ç®—ç»“æŸäº†ï¼Œè¿˜æœ‰å¾ˆå¤šç»†èŠ‚æ²¡æœ‰æ•´ç†ï¼Œæ¨èå»ä»”ç»†é˜…è¯» Doug Lea çš„è®ºæ–‡ï¼Œç„¶åç»“åˆ jdk æ–‡æ¡£å’Œä»£ç è¿›ä¸€æ­¥åŠ æ·±ç†è§£ã€‚</p>
<hr>
<h3 id="æ¨èé˜…è¯»ï¼š"><a href="#æ¨èé˜…è¯»ï¼š" class="headerlink" title="æ¨èé˜…è¯»ï¼š"></a>æ¨èé˜…è¯»ï¼š</h3><ul>
<li><a target="_blank" rel="noopener" href="http://ifeve.com/java-special-troops-aqs/">AQSçš„åŸç†æµ…æ</a></li>
<li><a target="_blank" rel="noopener" href="http://ifeve.com/reentrantlock-and-fairness/">ReentrantLock(é‡å…¥é”)ä»¥åŠå…¬å¹³æ€§</a></li>
</ul>
</div><div class="post-copyright"><script type="text/javascript" src="/js/copyright.js?v=1.0.0" successtext="å¤åˆ¶æˆåŠŸï¼"></script><link rel="stylesheet" type="text/css" href="/css/copyright.css?v=1.0.0"><p><span>æœ¬æ–‡æ ‡é¢˜ï¼š</span>Java AQSè§£æ(2)</p><p><span>æ–‡ç« ä½œè€…ï¼š</span>Ryan</p><p><span>åŸå§‹é“¾æ¥ï¼š</span><a href="/2023/01/15/Java-AQSè§£æ-2/">https://0x80x17.tech/2023/01/15/Java-AQS%E8%A7%A3%E6%9E%90-2/</a><span class="copy-path"><i class="fa fa-clipboard" data-clipboard-text="https://0x80x17.tech/2023/01/15/Java-AQS%E8%A7%A3%E6%9E%90-2/"></i></span></p><p><span>ç‰ˆæƒå£°æ˜ï¼š</span>è½¬è½½æˆ–å¼•ç”¨è¯·æ³¨æ˜æœ¬æ–‡é“¾æ¥ğŸ”—</p></div><br><div class="tags"><ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Java/" rel="tag">Java</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E7%BA%BF%E7%A8%8B-%E5%B9%B6%E5%8F%91/" rel="tag">çº¿ç¨‹&amp;å¹¶å‘</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E8%AE%BE%E8%AE%A1/" rel="tag">è®¾è®¡</a></li></ul></div><div class="post-nav"><a class="pre" href="/2023/02/12/Java-ThreadLocal%E8%A7%A3%E6%9E%90-1/">Java ThreadLocalè§£æ(1)</a><a class="next" href="/2023/01/09/Java-AQS%E8%A7%A3%E6%9E%90-1/">Java AQSè§£æ(1)</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="https://0x80x17.tech"/></form></div><div class="widget"><div class="author-info"><a class="info-avatar" href="/about/" title="å…³äº"><img class="nofancybox" src="/img/avatar.png"/></a><p>A Lean Coder.</p></div></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> æ ‡ç­¾</i></div><div class="tagcloud"><a href="/tags/%E8%AE%BE%E8%AE%A1/" style="font-size: 15px;">è®¾è®¡</a> <a href="/tags/%E5%88%86%E5%B8%83%E5%BC%8F%E7%B3%BB%E7%BB%9F/" style="font-size: 15px;">åˆ†å¸ƒå¼ç³»ç»Ÿ</a> <a href="/tags/%E7%BF%BB%E8%AF%91/" style="font-size: 15px;">ç¿»è¯‘</a> <a href="/tags/Java/" style="font-size: 15px;">Java</a> <a href="/tags/%E8%99%9A%E6%8B%9F%E6%9C%BA/" style="font-size: 15px;">è™šæ‹Ÿæœº</a> <a href="/tags/%E7%BA%BF%E7%A8%8B-%E5%B9%B6%E5%8F%91/" style="font-size: 15px;">çº¿ç¨‹&å¹¶å‘</a> <a href="/tags/%E7%BB%8F%E9%AA%8C%E6%95%99%E8%AE%AD/" style="font-size: 15px;">ç»éªŒæ•™è®­</a> <a href="/tags/%E8%AF%AD%E6%B3%95/" style="font-size: 15px;">è¯­æ³•</a> <a href="/tags/%E5%B7%A5%E5%85%B7/" style="font-size: 15px;">å·¥å…·</a> <a href="/tags/%E4%B8%AD%E9%97%B4%E4%BB%B6/" style="font-size: 15px;">ä¸­é—´ä»¶</a> <a href="/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84-%E7%AE%97%E6%B3%95/" style="font-size: 15px;">æ•°æ®ç»“æ„&ç®—æ³•</a> <a href="/tags/JS/" style="font-size: 15px;">JS</a> <a href="/tags/%E7%BD%91%E7%BB%9C/" style="font-size: 15px;">ç½‘ç»œ</a> <a href="/tags/%E4%BC%98%E5%8C%96/" style="font-size: 15px;">ä¼˜åŒ–</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> æœ€è¿‘æ–‡ç« </i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2023/04/30/%E7%86%94%E6%96%AD-%E9%99%8D%E7%BA%A7/">ç†”æ–­&é™çº§</a></li><li class="post-list-item"><a class="post-list-link" href="/2023/04/19/%E5%85%B3%E4%BA%8E%E6%B5%81%E9%87%8F%E6%8E%A7%E5%88%B6/">å…³äºæµé‡æ§åˆ¶</a></li><li class="post-list-item"><a class="post-list-link" href="/2023/03/03/%E8%81%8A%E8%81%8A%E5%B9%82%E7%AD%89/">èŠèŠå¹‚ç­‰</a></li><li class="post-list-item"><a class="post-list-link" href="/2023/02/19/Java-ThreadLocal%E8%A7%A3%E6%9E%90-2/">Java ThreadLocalè§£æ(2)</a></li><li class="post-list-item"><a class="post-list-link" href="/2023/02/12/Java-ThreadLocal%E8%A7%A3%E6%9E%90-1/">Java ThreadLocalè§£æ(1)</a></li><li class="post-list-item"><a class="post-list-link" href="/2023/01/15/Java-AQS%E8%A7%A3%E6%9E%90-2/">Java AQSè§£æ(2)</a></li><li class="post-list-item"><a class="post-list-link" href="/2023/01/09/Java-AQS%E8%A7%A3%E6%9E%90-1/">Java AQSè§£æ(1)</a></li><li class="post-list-item"><a class="post-list-link" href="/2022/12/15/Java-%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B%E8%A7%A3%E8%AF%BB-2/">Java å†…å­˜æ¨¡å‹è§£è¯»(2)</a></li><li class="post-list-item"><a class="post-list-link" href="/2022/12/12/Java-%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B%E8%A7%A3%E8%AF%BB-1/">Java å†…å­˜æ¨¡å‹è§£è¯»(1)</a></li><li class="post-list-item"><a class="post-list-link" href="/2022/11/29/%E5%86%8D%E8%B0%88-Java%E7%BA%BF%E7%A8%8B%E6%B1%A0/">å†è°ˆ Javaçº¿ç¨‹æ± </a></li></ul></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright Â© 2023 <a href="/." rel="nofollow">0x80x17.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=1.0.0" async></script><script type="text/javascript" src="//lib.baomitu.com/fancybox/latest/jquery.fancybox.min.js"></script><script type="text/javascript" src="/js/fancybox.js?v=1.0.0"></script><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/fancybox/latest/jquery.fancybox.min.css"><script type="text/javascript" src="/js/copycode.js?v=1.0.0" successtext="å¤åˆ¶æˆåŠŸï¼"></script><link rel="stylesheet" type="text/css" href="/css/copycode.css?v=1.0.0"><script type="text/javascript" src="/js/codeblock-resizer.js?v=1.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=1.0.0"></script></div></body></html>