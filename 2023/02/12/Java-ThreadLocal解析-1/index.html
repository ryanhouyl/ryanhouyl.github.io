<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content=""><title>Java ThreadLocalè§£æ(1) | 0x80x17</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=1.0.0"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/normalize/latest/normalize.min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/latest/pure-min.min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/latest/grids-responsive-min.min.css"><link rel="stylesheet" href="//lib.baomitu.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//lib.baomitu.com/jquery/latest/jquery.min.js"></script><link rel="icon" mask="" sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><script type="text/javascript" src="//lib.baomitu.com/clipboard.js/latest/clipboard.min.js"></script><script type="text/javascript" src="//lib.baomitu.com/toastr.js/latest/toastr.min.js"></script><link rel="stylesheet" href="//lib.baomitu.com/toastr.js/latest/toastr.min.css"><meta name="generator" content="Hexo 7.0.0"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">Java ThreadLocalè§£æ(1)</h1><a id="logo" href="/.">0x80x17</a><p class="description">hello, world:)</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> é¦–é¡µ</i></a><a href="/archives/"><i class="fa fa-archive"> å½’æ¡£</i></a><a href="/about/"><i class="fa fa-user"> å…³äº</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">Java ThreadLocalè§£æ(1)</h1><div class="post-meta">2023-02-12</div><div class="clear"><div class="toc-article" id="toc"><div class="toc-title">æ–‡ç« ç›®å½•</div><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%98%AF%E4%BB%80%E4%B9%88"><span class="toc-text">æ˜¯ä»€ä¹ˆ</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88"><span class="toc-text">ä¸ºä»€ä¹ˆ</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%BE%E4%B8%AA%E4%BE%8B%E5%AD%90"><span class="toc-text">ä¸¾ä¸ªä¾‹å­</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ThreadLocal%E7%9A%84%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86"><span class="toc-text">ThreadLocalçš„å®ç°åŸç†</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%87%8D%E8%A6%81%E7%9A%84API"><span class="toc-text">é‡è¦çš„API</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%80%9A%E8%BF%87-get-%E6%96%B9%E6%B3%95%E7%9A%84%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E4%B8%8BThreadLocal%E7%9A%84%E8%AE%BE%E8%AE%A1"><span class="toc-text">é€šè¿‡ get() æ–¹æ³•çš„æºç åˆ†æä¸‹ThreadLocalçš„è®¾è®¡</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ThreadLocal%E7%9A%84%E5%86%85%E5%AD%98%E6%B3%84%E6%BC%8F%E9%97%AE%E9%A2%98"><span class="toc-text">ThreadLocalçš„å†…å­˜æ³„æ¼é—®é¢˜</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E6%96%87%E7%AB%A0%EF%BC%9A"><span class="toc-text">å‚è€ƒæ–‡ç« ï¼š</span></a></li></ol></div></div><div class="post-content"><h3 id="æ˜¯ä»€ä¹ˆ"><a href="#æ˜¯ä»€ä¹ˆ" class="headerlink" title="æ˜¯ä»€ä¹ˆ"></a>æ˜¯ä»€ä¹ˆ</h3><p>è¿™ä¸ªç±»çš„åå­—å·²ç»å¾ˆæ¸…æ¥šçš„å‘Šè¯‰æˆ‘ä»¬è¯¥ç±»çš„ä½œç”¨äº†ï¼Œå³<code>çº¿ç¨‹å±€éƒ¨å˜é‡</code>ï¼Œå¯ä»¥ç±»æ¯”ä¸€èˆ¬çš„å±€éƒ¨å˜é‡ï¼Œ<code>ThreadLocal</code>è¯´æ˜äº†è¯¥å±€éƒ¨å˜é‡çš„ä¸Šä¸‹æ–‡ç¯å¢ƒä¸º<code>Thread</code>ï¼Œå³æ¯ä¸ªçº¿ç¨‹éƒ½æœ‰ä¸€ä¸ªäº’ä¸å½±å“çš„å˜é‡ï¼Œå¯ä»¥é€šè¿‡<code>get()</code>æˆ–è€…<code>set(T value)</code>ç­‰æ–¹æ³•åˆ†åˆ«æ“ä½œè‡ªå·±çš„å˜é‡å‰¯æœ¬ï¼Œè€Œå¯¹å…¶ä»–çš„çº¿ç¨‹æ“ä½œä¿æŒå°é—­</p>
<h3 id="ä¸ºä»€ä¹ˆ"><a href="#ä¸ºä»€ä¹ˆ" class="headerlink" title="ä¸ºä»€ä¹ˆ"></a>ä¸ºä»€ä¹ˆ</h3><p>é‚£ä¹ˆä¸ºä»€ä¹ˆéœ€è¦ä½¿ç”¨ThreadLocalå‘¢ï¼Ÿå¯ä»¥è€ƒè™‘è¿™æ ·ä¸¤ä¸ªåœºæ™¯ï¼š</p>
<ul>
<li>åœ¨åŒä¸€ä¸ªçº¿ç¨‹ä¸­çš„å¤šä¸ªå‡½æ•°éœ€è¦æ“ä½œç›¸åŒçš„æ•°æ®ï¼Œæ€ä¹ˆå¤„ç†ï¼Ÿä¸€ç§æ¯”è¾ƒç›´æ¥çš„æ–¹å¼å°±æ˜¯é€šè¿‡åœ¨å¤šä¸ªå‡½æ•°ä¹‹é—´è¿›è¡Œå‚æ•°çš„ä¼ é€’ï¼Œä½†æ˜¯è¿™ç§æ–¹å¼éœ€è¦ç»™æ¯ä¸ªå‚ä¸çš„æ–¹æ³•éƒ½å¢åŠ ä¸€ä¸ªå‚æ•°ï¼Œè¿™å¹¶ä¸ä¼˜é›…</li>
<li>é’ˆå¯¹ä¸Šé¢çš„é—®é¢˜ï¼Œæˆ‘ä»¬å¯ä»¥æä¾›ä¸€ä¸ªå…¨å±€å˜é‡ä¾›æ‰€æœ‰çš„å‡½æ•°è®¿é—®ï¼Œä½†æ˜¯åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹ï¼Œéœ€è¦è¿›è¡ŒåŒæ­¥å¤„ç†</li>
</ul>
<span id="more"></span>

<p>ç»¼åˆä¸Šé¢ä¸¤ç§æƒ…å†µï¼Œæˆ‘ä»¬å¼•å…¥äº†ThreadLocalå˜é‡ï¼Œæä¾›äº†çº¿ç¨‹ä¸Šä¸‹æ–‡ç¯å¢ƒä¸‹çš„å±€éƒ¨å˜é‡</p>
<h3 id="ä¸¾ä¸ªä¾‹å­"><a href="#ä¸¾ä¸ªä¾‹å­" class="headerlink" title="ä¸¾ä¸ªä¾‹å­"></a>ä¸¾ä¸ªä¾‹å­</h3><p>åœ¨åˆ†æ<code>ThreadLocal</code>çš„å®ç°åŸç†å‰ï¼Œæˆ‘ä»¬å…ˆçœ‹ä¸€ä¸ªç¤ºä¾‹ä»£ç ï¼š</p>
<p>æœ‰ä¸‰ä¸ªçº¿ç¨‹ï¼Œæ¯ä¸ªçº¿ç¨‹éƒ½æœ‰ä¸€ä¸ªå€¼valueï¼Œåˆå§‹å€¼ä¸º0ï¼Œçº¿ç¨‹è¿è¡Œæ—¶ç”¨ä¸€ä¸ªå¾ªç¯å¾€valueå€¼ç´¯åŠ æ•°å­—ï¼Œæœ€åä¼šå¾—åˆ°æ¯ä¸ªçº¿ç¨‹çš„ç´¯åŠ å€¼éƒ½ä¸€æ ·ã€‚<strong>ä¹Ÿå°±æ˜¯è¯´å„ä¸ªçº¿ç¨‹çš„valueå€¼æ˜¯ç›¸äº’ç‹¬ç«‹çš„ï¼Œæœ¬çº¿ç¨‹çš„ç´¯åŠ æ“ä½œä¸ä¼šå½±å“åˆ°å…¶ä»–çº¿ç¨‹çš„å€¼ï¼Œè¾¾åˆ°çº¿ç¨‹éš”ç¦»çš„æ•ˆæœ</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">TestThreadLocal</span> &#123;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ThreadLocal&lt;Integer&gt; value = <span class="keyword">new</span> <span class="title class_">ThreadLocal</span>&lt;&gt;() &#123;</span><br><span class="line">		<span class="meta">@Override</span></span><br><span class="line">		<span class="keyword">protected</span> Integer <span class="title function_">initialValue</span><span class="params">()</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">MyThread</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span> &#123;</span><br><span class="line">		<span class="keyword">private</span> <span class="type">int</span> index;</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">public</span> <span class="title function_">MyThread</span><span class="params">(<span class="type">int</span> index)</span> &#123;</span><br><span class="line">			<span class="built_in">this</span>.index = index;</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">			System.out.println(<span class="string">&quot;çº¿ç¨‹&quot;</span> ï¼‹ index + <span class="string">&quot;çš„åˆå§‹valueï¼š&quot;</span> + value.get());</span><br><span class="line">			<span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">5</span>; i++) &#123;</span><br><span class="line">				value.set(value.get() + i);</span><br><span class="line">			&#125;</span><br><span class="line">			System.out.println(<span class="string">&quot;çº¿ç¨‹&quot;</span> + index + <span class="string">&quot;çš„ç´¯åŠ valueï¼š&quot;</span> + value.get());</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">		<span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">3</span>; i++) &#123;</span><br><span class="line">			<span class="keyword">new</span> <span class="title class_">Thread</span>(<span class="keyword">new</span> <span class="title class_">MyThread</span>(i)).start();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="ThreadLocalçš„å®ç°åŸç†"><a href="#ThreadLocalçš„å®ç°åŸç†" class="headerlink" title="ThreadLocalçš„å®ç°åŸç†"></a>ThreadLocalçš„å®ç°åŸç†</h3><p>è®©æˆ‘ä»¬è‡ªå·±æ¥å®ç°ä¸€ä¸ªThreadLocalï¼Œæˆ‘ä»¬å¯èƒ½å¾ˆå®¹æ˜“å°±ä¼šæƒ³åˆ°é€šè¿‡å°è£…ä¸€ä¸ªMapå¯¹è±¡æ¥å®ç°ï¼ŒMap çš„keyä¸ºçº¿ç¨‹çš„IDï¼Œvalueä¸ºå¯¹åº”çš„å®ä¾‹å¯¹è±¡ï¼Œè¿™æ ·å°±å¯ä»¥å®ç°çº¿ç¨‹éš”ç¦»çš„æ•ˆæœã€‚æ—©æœŸçš„jdkç‰ˆæœ¬ä¹Ÿç¡®å®æ˜¯è¿™æ ·å®ç°çš„ï¼Œä½†æ˜¯åœ¨jdk8ä¸­ï¼Œå·²ç»é‡‡ç”¨äº†åˆ«çš„å®ç°æ–¹å¼ï¼Œä¸‹é¢æ¥å…·ä½“çš„çœ‹ä¸€ä¸‹</p>
<h4 id="é‡è¦çš„API"><a href="#é‡è¦çš„API" class="headerlink" title="é‡è¦çš„API"></a>é‡è¦çš„API</h4><ul>
<li><code>public T get()</code>: Returns the value in the current threadâ€™s copy of this thread-local variable. If the variable has no value for the current thread, it is first initialized to the value returned by an invocation of the initialValue() method.</li>
<li><code>protected T initialValue()</code>: Returns the current threadâ€™s â€œinitial valueâ€ for this thread-local variable. This method will be invoked the first time a thread accesses the variable with the get() method, unless the thread previously invoked the set(T) method, in which case the initialValue method will not be invoked for the thread. This implementation simply returns null; if the programmer desires thread-local variables to have an initial value other than null, ThreadLocal must be subclassed, and this method overridden. Typically, an anonymous inner class will be used.</li>
<li><code>public void set(T value)</code>ï¼šSets the current threadâ€™s copy of this thread-local variable to the specified value</li>
<li><code>public void remove()</code>ï¼šRemoves the current threadâ€™s value for this thread-local variable. If this thread-local variable is subsequently read by the current thread, its value will be reinitialized by invoking its initialValue() method, unless its value is set by the current thread in the interim.</li>
</ul>
<h4 id="é€šè¿‡-get-æ–¹æ³•çš„æºç åˆ†æä¸‹ThreadLocalçš„è®¾è®¡"><a href="#é€šè¿‡-get-æ–¹æ³•çš„æºç åˆ†æä¸‹ThreadLocalçš„è®¾è®¡" class="headerlink" title="é€šè¿‡ get() æ–¹æ³•çš„æºç åˆ†æä¸‹ThreadLocalçš„è®¾è®¡"></a>é€šè¿‡ get() æ–¹æ³•çš„æºç åˆ†æä¸‹ThreadLocalçš„è®¾è®¡</h4><ul>
<li>public T get() æ–¹æ³•æºç å¦‚ä¸‹ï¼š</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Returns the value in the current thread&#x27;s copy of this</span></span><br><span class="line"><span class="comment">    * thread-local variable.  If the variable has no value for the</span></span><br><span class="line"><span class="comment">    * current thread, it is first initialized to the value returned</span></span><br><span class="line"><span class="comment">    * by an invocation of the &#123;<span class="doctag">@link</span> #initialValue&#125; method.</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span> the current thread&#x27;s value of this thread-local</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="keyword">public</span> T <span class="title function_">get</span><span class="params">()</span> &#123;</span><br><span class="line">       <span class="type">Thread</span> <span class="variable">t</span> <span class="operator">=</span> Thread.currentThread();</span><br><span class="line">       <span class="type">ThreadLocalMap</span> <span class="variable">map</span> <span class="operator">=</span> getMap(t);</span><br><span class="line">       <span class="keyword">if</span> (map != <span class="literal">null</span>) &#123;</span><br><span class="line">           ThreadLocalMap.<span class="type">Entry</span> <span class="variable">e</span> <span class="operator">=</span> map.getEntry(<span class="built_in">this</span>);</span><br><span class="line">           <span class="keyword">if</span> (e != <span class="literal">null</span>) &#123;</span><br><span class="line">               <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">               <span class="type">T</span> <span class="variable">result</span> <span class="operator">=</span> (T)e.value;</span><br><span class="line">               <span class="keyword">return</span> result;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> setInitialValue();</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>æºç å’Œæ³¨é‡Šå…¶å®éå¸¸çš„æ¸…æ™°ï¼Œæˆ‘ä»¬åªéœ€è¦æ ¹æ®ä»£ç çš„è°ƒç”¨æ¥èµ°è¯»ä¸€ä¸‹å³å¯ï¼Œé¦–å…ˆæˆ‘ä»¬å…ˆè·å–å½“å‰çº¿ç¨‹tï¼Œç„¶åè·å–å¯¹åº”çº¿ç¨‹tçš„ThreadLocalMapå˜é‡mapï¼Œæˆ‘ä»¬å¯ä»¥å…·ä½“çœ‹ä¸€ä¸‹<code>getMap(t)</code>çš„æºç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Get the map associated with a ThreadLocal. Overridden in</span></span><br><span class="line"><span class="comment">    * InheritableThreadLocal.</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span>  t the current thread</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span> the map</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   ThreadLocalMap <span class="title function_">getMap</span><span class="params">(Thread t)</span> &#123;</span><br><span class="line">       <span class="keyword">return</span> t.threadLocals;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>åœ¨Threadç±»å†…éƒ¨ç»´æŠ¤ä¸€ä¸ªæŒ‡å‘ThreadLocalçš„ThreadLocalMapåŒ…çº§ç§æœ‰é™æ€ç±»çš„å­—æ®µï¼šthreadLocalsï¼Œé€šè¿‡åˆ†æå¯ä»¥çŸ¥é“ï¼Œ<strong>æ•´ä¸ªThreadLocalæœ€æ ¸å¿ƒçš„éƒ¨åˆ†å°±åœ¨ThreadLocalMapç±»ä¸­ï¼ŒåŒ…æ‹¬æ ¹æ®hashè¿›è¡Œç´¢å¼•æ’å…¥ï¼Œé€šè¿‡å¼€æ”¾åœ°å€æ³•è§£å†³hashå†²çªé—®é¢˜ç­‰</strong>ï¼Œéƒ¨åˆ†ä»£è¡¨ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ThreadLocal</span> &#123;</span><br><span class="line">...</span><br><span class="line">	<span class="comment">/** ThreadLocalMap is a customized hash map suitable only for</span></span><br><span class="line"><span class="comment"> 	  * maintaining thread local values. No operations are exported</span></span><br><span class="line"><span class="comment"> 	  * outside of the ThreadLocal class. The class is package private to</span></span><br><span class="line"><span class="comment"> 	  * allow declaration of fields in class Thread.</span></span><br><span class="line"><span class="comment"> 	  * .....</span></span><br><span class="line"><span class="comment">	 /</span></span><br><span class="line"><span class="comment">	static class ThreadLocalMap &#123;</span></span><br><span class="line"><span class="comment">		static class Entry extends WeakReference&lt;ThreadLocal&lt;?&gt;&gt; &#123;</span></span><br><span class="line"><span class="comment">			Object value;</span></span><br><span class="line"><span class="comment">			...</span></span><br><span class="line"><span class="comment">		&#125;</span></span><br><span class="line"><span class="comment">		...</span></span><br><span class="line"><span class="comment">		private Entry[] table;</span></span><br><span class="line"><span class="comment">		</span></span><br><span class="line"><span class="comment">		/**</span></span><br><span class="line"><span class="comment">         * Get the entry associated with key.  This method</span></span><br><span class="line"><span class="comment">         * itself handles only the fast path: a direct hit of existing</span></span><br><span class="line"><span class="comment">         * key. It otherwise relays to getEntryAfterMiss.  This is</span></span><br><span class="line"><span class="comment">         * designed to maximize performance for direct hits, in part</span></span><br><span class="line"><span class="comment">         * by making this method readily inlinable.</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span>  key the thread local object</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@return</span> the entry associated with key, or null if no such</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">		<span class="keyword">private</span> Entry <span class="title function_">getEntry</span><span class="params">(ThreadLocal&lt;?&gt; key)</span> &#123;</span><br><span class="line">			<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> key.threadLocalHashCode &amp; (table.length - <span class="number">1</span>);</span><br><span class="line">			<span class="type">Entry</span> <span class="variable">e</span> <span class="operator">=</span> table[i];</span><br><span class="line">			<span class="keyword">if</span> (e != <span class="literal">null</span> &amp;&amp; e.get() == key)</span><br><span class="line">				<span class="keyword">return</span> e;</span><br><span class="line">			<span class="keyword">else</span> </span><br><span class="line">				<span class="keyword">return</span> getEntryAfterMiss(key, i, e);</span><br><span class="line">		&#125;</span><br><span class="line">		...</span><br><span class="line">		<span class="comment">/**</span></span><br><span class="line"><span class="comment">         * Version of getEntry method for use when key is not found in</span></span><br><span class="line"><span class="comment">         * its direct hash slot.</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span>  key the thread local object</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span>  i the table index for key&#x27;s hash code</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span>  e the entry at table[i]</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@return</span> the entry associated with key, or null if no such</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">		<span class="keyword">private</span> Entry <span class="title function_">getEntryAfterMiss</span><span class="params">(ThreadLoca&lt;?&gt; key, <span class="type">int</span> i, Entry e)</span> &#123;</span><br><span class="line">		...</span><br><span class="line">		&#125;</span><br><span class="line">		...</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ ¹æ®ä¸Šé¢ä»£ç æ€»ç»“ä¸€ä¸‹ThreadLocalçš„ç»“æ„ï¼š<strong>é¦–å…ˆï¼Œåœ¨æ¯ä¸ªçº¿ç¨‹Threadå†…éƒ¨æœ‰ä¸€ä¸ªThreadLocal.ThreadLocalMapç±»å‹çš„æˆå‘˜å˜é‡threadLocalsï¼Œè¿™ä¸ªthreadLocalså°±æ˜¯ç”¨æ¥å­˜å‚¨å®é™…çš„å˜é‡å‰¯æœ¬çš„ï¼Œå†…éƒ¨ç”±åä¸ºtableçš„Entryæ•°ç»„ç»´æŠ¤ï¼ŒEntryçš„é”®å€¼ä¸ºå½“å‰ThreadLocalå˜é‡ï¼Œvalueä¸ºå˜é‡å‰¯æœ¬ï¼ˆå³Tç±»å‹çš„å˜é‡)</strong></p>
<p>ThreadLocal çš„ <code>public T get()</code> æ–¹æ³•çš„æ‰§è¡Œè¿‡ç¨‹å¦‚ä¸‹ï¼š</p>
<ul>
<li>å…ˆè·å–å½“å‰çº¿ç¨‹ï¼š Thread.currentThread()</li>
<li>æ ¹æ®å½“å‰çº¿ç¨‹è·å– ThreadLocalMap(Entry æ•°ç»„ï¼ŒEntry ç»§æ‰¿è‡ªå¼±å¼•ç”¨ WeakReferenceï¼ŒEntry çš„ key ä¸º ThreadLocal å€¼ï¼Œvalue ä¸ºæ¯ä¸ªçº¿ç¨‹ç‹¬ç«‹çš„å€¼ Object): getMap(t)</li>
<li>å¦‚æœmapä¸ºç©ºï¼Œè°ƒç”¨setInitialValue() æ–¹æ³•è¿›è¡Œåˆå§‹åŒ–æ“ä½œ</li>
<li>map ä¸ä¸ºç©ºï¼Œè·å–threadLocalåœ¨è¯¥çº¿ç¨‹çš„ä¸­çš„valueå€¼ï¼šThreadLocalMap.Entry e &#x3D; map.getEntry(this); T result &#x3D; (T) e.value;</li>
</ul>
<p>ç°åœ¨æ•´ä¸ªThreadLocalçš„ç»“æ„å·²ç»å¾ˆæ¸…æ™°äº†ï¼Œå¯ä»¥å‚è€ƒä¸‹é¢çš„å›¾è¿›è¡Œç†è§£ï¼ˆ<strong>å›¾ç‰‡çš„å‡ºå¤„ä¼šåœ¨æœ€åå¼•ç”¨çš„æ–‡ç« é“¾æ¥ä¸­ç»™å‡º</strong>ï¼‰</p>
<p><img src="https://0x80x17.tech/img/threadLocal.png"></p>
<h3 id="ThreadLocalçš„å†…å­˜æ³„æ¼é—®é¢˜"><a href="#ThreadLocalçš„å†…å­˜æ³„æ¼é—®é¢˜" class="headerlink" title="ThreadLocalçš„å†…å­˜æ³„æ¼é—®é¢˜"></a>ThreadLocalçš„å†…å­˜æ³„æ¼é—®é¢˜</h3><p>èµ·å› ï¼šThreadLocalMapä½¿ç”¨ThreadLocalçš„å¼±å¼•ç”¨ä½œä¸ºkeyï¼Œå¦‚æœä¸€ä¸ªThreadLocalæ²¡æœ‰å¤–éƒ¨å¼ºå¼•ç”¨å¼•ç”¨ä»–ï¼Œé‚£ä¹ˆç³»ç»Ÿgcçš„æ—¶å€™ï¼Œè¿™ä¸ªThreadLocalåŠ¿å¿…ä¼šè¢«å›æ”¶ï¼Œè¿™æ ·ä¸€æ¥ï¼ŒThreadLocalMapä¸­å°±ä¼šå‡ºç°keyä¸ºnullçš„Entryï¼Œå°±æ²¡æœ‰åŠæ³•è®¿é—®è¿™äº›keyä¸ºnullçš„Entryçš„valueï¼Œå¦‚æœå½“å‰çº¿ç¨‹å†è¿Ÿè¿Ÿä¸ç»“æŸçš„è¯ï¼Œè¿™äº›keyä¸ºnullçš„Entryçš„valueå°±ä¼šä¸€ç›´å­˜åœ¨ä¸€æ¡å¼ºå¼•ç”¨é“¾ï¼š<br><code>Thread Ref -&gt; Thread -&gt; ThreaLocalMap -&gt; Entry -&gt; value</code></p>
<p>è§£å†³ï¼šäº‹å®ä¸Šjdkåœ¨è®¾è®¡çš„æ—¶å€™å·²ç»è€ƒè™‘åˆ°äº†è¿™ä¸ªæƒ…å†µï¼Œåœ¨getEntryå‡½æ•°å’Œsetå‡½æ•°ä¸­ä¼šå¯¹keyä¸ºnullçš„Entryè¿›è¡Œæ“¦å‡ºï¼Œ<strong>ä½†æ˜¯</strong>ï¼Œä¸Šé¢çš„è®¾è®¡æ€è·¯ä¾èµ–ä¸€ä¸ªå‰ææ¡ä»¶ï¼šè¦è°ƒç”¨ThreadLocalMapçš„genEntryå‡½æ•°æˆ–è€…setå‡½æ•°ã€‚è¿™å½“ç„¶æ˜¯ä¸å¯èƒ½ä»»ä½•æƒ…å†µéƒ½æˆç«‹çš„ï¼Œæ‰€ä»¥å¾ˆå¤šæƒ…å†µä¸‹éœ€è¦ä½¿ç”¨è€…æ‰‹åŠ¨è°ƒç”¨ThreadLocalçš„removeå‡½æ•°ï¼Œæ‰‹åŠ¨åˆ é™¤ä¸å†éœ€è¦çš„ThreadLocalï¼Œé˜²æ­¢å†…å­˜æ³„éœ²ã€‚<strong>æ‰€ä»¥JDKå»ºè®®å°†ThreadLocalå˜é‡å®šä¹‰æˆprivate staticçš„ï¼Œè¿™æ ·çš„è¯ThreadLocalçš„ç”Ÿå‘½å‘¨æœŸå°±æ›´é•¿ï¼Œç”±äºä¸€ç›´å­˜åœ¨ThreadLocalçš„å¼ºå¼•ç”¨ï¼Œæ‰€ä»¥ThreadLocalä¹Ÿå°±ä¸ä¼šè¢«å›æ”¶ï¼Œä¹Ÿå°±èƒ½ä¿è¯ä»»ä½•æ—¶å€™éƒ½èƒ½æ ¹æ®ThreadLocalçš„å¼±å¼•ç”¨è®¿é—®åˆ°Entryçš„valueå€¼ï¼Œç„¶åremoveå®ƒï¼Œé˜²æ­¢å†…å­˜æ³„éœ²ã€‚</strong></p>
<hr>
<h3 id="å‚è€ƒæ–‡ç« ï¼š"><a href="#å‚è€ƒæ–‡ç« ï¼š" class="headerlink" title="å‚è€ƒæ–‡ç« ï¼š"></a>å‚è€ƒæ–‡ç« ï¼š</h3><ul>
<li><a target="_blank" rel="noopener" href="http://blog.decaywood.me/2016/03/15/ThreadLocal-intro/">ThreadLocalåŸç†åˆ†æ</a></li>
<li><a target="_blank" rel="noopener" href="https://www.zhihu.com/question/23089780/answer/62097840">ThreadLocalåŸç†</a></li>
</ul>
</div><div class="post-copyright"><script type="text/javascript" src="/js/copyright.js?v=1.0.0" successtext="å¤åˆ¶æˆåŠŸï¼"></script><link rel="stylesheet" type="text/css" href="/css/copyright.css?v=1.0.0"><p><span>æœ¬æ–‡æ ‡é¢˜ï¼š</span>Java ThreadLocalè§£æ(1)</p><p><span>æ–‡ç« ä½œè€…ï¼š</span>Ryan</p><p><span>åŸå§‹é“¾æ¥ï¼š</span><a href="/2023/02/12/Java-ThreadLocalè§£æ-1/">https://0x80x17.tech/2023/02/12/Java-ThreadLocal%E8%A7%A3%E6%9E%90-1/</a><span class="copy-path"><i class="fa fa-clipboard" data-clipboard-text="https://0x80x17.tech/2023/02/12/Java-ThreadLocal%E8%A7%A3%E6%9E%90-1/"></i></span></p><p><span>ç‰ˆæƒå£°æ˜ï¼š</span>è½¬è½½æˆ–å¼•ç”¨è¯·æ³¨æ˜æœ¬æ–‡é“¾æ¥ğŸ”—</p></div><br><div class="tags"><ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Java/" rel="tag">Java</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E7%BA%BF%E7%A8%8B-%E5%B9%B6%E5%8F%91/" rel="tag">çº¿ç¨‹&amp;å¹¶å‘</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E8%AE%BE%E8%AE%A1/" rel="tag">è®¾è®¡</a></li></ul></div><div class="post-nav"><a class="pre" href="/2023/02/19/Java-ThreadLocal%E8%A7%A3%E6%9E%90-2/">Java ThreadLocalè§£æ(2)</a><a class="next" href="/2023/01/15/Java-AQS%E8%A7%A3%E6%9E%90-2/">Java AQSè§£æ(2)</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="https://0x80x17.tech"/></form></div><div class="widget"><div class="author-info"><a class="info-avatar" href="/about/" title="å…³äº"><img class="nofancybox" src="/img/avatar.png"/></a><p>A Lean Coder.</p></div></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> æ ‡ç­¾</i></div><div class="tagcloud"><a href="/tags/%E8%AE%BE%E8%AE%A1/" style="font-size: 15px;">è®¾è®¡</a> <a href="/tags/%E5%88%86%E5%B8%83%E5%BC%8F%E7%B3%BB%E7%BB%9F/" style="font-size: 15px;">åˆ†å¸ƒå¼ç³»ç»Ÿ</a> <a href="/tags/%E7%BF%BB%E8%AF%91/" style="font-size: 15px;">ç¿»è¯‘</a> <a href="/tags/Java/" style="font-size: 15px;">Java</a> <a href="/tags/%E8%99%9A%E6%8B%9F%E6%9C%BA/" style="font-size: 15px;">è™šæ‹Ÿæœº</a> <a href="/tags/%E7%BA%BF%E7%A8%8B-%E5%B9%B6%E5%8F%91/" style="font-size: 15px;">çº¿ç¨‹&å¹¶å‘</a> <a href="/tags/%E7%BB%8F%E9%AA%8C%E6%95%99%E8%AE%AD/" style="font-size: 15px;">ç»éªŒæ•™è®­</a> <a href="/tags/%E8%AF%AD%E6%B3%95/" style="font-size: 15px;">è¯­æ³•</a> <a href="/tags/%E5%B7%A5%E5%85%B7/" style="font-size: 15px;">å·¥å…·</a> <a href="/tags/%E4%B8%AD%E9%97%B4%E4%BB%B6/" style="font-size: 15px;">ä¸­é—´ä»¶</a> <a href="/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84-%E7%AE%97%E6%B3%95/" style="font-size: 15px;">æ•°æ®ç»“æ„&ç®—æ³•</a> <a href="/tags/JS/" style="font-size: 15px;">JS</a> <a href="/tags/%E7%BD%91%E7%BB%9C/" style="font-size: 15px;">ç½‘ç»œ</a> <a href="/tags/%E5%AE%89%E5%85%A8/" style="font-size: 15px;">å®‰å…¨</a> <a href="/tags/%E4%BC%98%E5%8C%96/" style="font-size: 15px;">ä¼˜åŒ–</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> æœ€è¿‘æ–‡ç« </i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2023/06/01/%E5%85%B3%E4%BA%8E%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1/">å…³äºè´Ÿè½½å‡è¡¡</a></li><li class="post-list-item"><a class="post-list-link" href="/2023/05/17/%E5%85%B3%E4%BA%8E-Skip-list/">å…³äº Skip list</a></li><li class="post-list-item"><a class="post-list-link" href="/2023/04/30/%E7%86%94%E6%96%AD-%E9%99%8D%E7%BA%A7/">ç†”æ–­&é™çº§</a></li><li class="post-list-item"><a class="post-list-link" href="/2023/04/19/%E5%85%B3%E4%BA%8E%E6%B5%81%E9%87%8F%E6%8E%A7%E5%88%B6/">å…³äºæµé‡æ§åˆ¶</a></li><li class="post-list-item"><a class="post-list-link" href="/2023/03/03/%E8%81%8A%E8%81%8A%E5%B9%82%E7%AD%89/">èŠèŠå¹‚ç­‰</a></li><li class="post-list-item"><a class="post-list-link" href="/2023/02/19/Java-ThreadLocal%E8%A7%A3%E6%9E%90-2/">Java ThreadLocalè§£æ(2)</a></li><li class="post-list-item"><a class="post-list-link" href="/2023/02/12/Java-ThreadLocal%E8%A7%A3%E6%9E%90-1/">Java ThreadLocalè§£æ(1)</a></li><li class="post-list-item"><a class="post-list-link" href="/2023/01/15/Java-AQS%E8%A7%A3%E6%9E%90-2/">Java AQSè§£æ(2)</a></li><li class="post-list-item"><a class="post-list-link" href="/2023/01/09/Java-AQS%E8%A7%A3%E6%9E%90-1/">Java AQSè§£æ(1)</a></li><li class="post-list-item"><a class="post-list-link" href="/2022/12/15/Java-%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B%E8%A7%A3%E8%AF%BB-2/">Java å†…å­˜æ¨¡å‹è§£è¯»(2)</a></li></ul></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright Â© 2023 <a href="/." rel="nofollow">0x80x17.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=1.0.0" async></script><script type="text/javascript" src="//lib.baomitu.com/fancybox/latest/jquery.fancybox.min.js"></script><script type="text/javascript" src="/js/fancybox.js?v=1.0.0"></script><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/fancybox/latest/jquery.fancybox.min.css"><script type="text/javascript" src="/js/copycode.js?v=1.0.0" successtext="å¤åˆ¶æˆåŠŸï¼"></script><link rel="stylesheet" type="text/css" href="/css/copycode.css?v=1.0.0"><script type="text/javascript" src="/js/codeblock-resizer.js?v=1.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=1.0.0"></script></div></body></html>